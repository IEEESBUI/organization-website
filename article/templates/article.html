{% extends "base.html" %}
{% load static %}

{% block title %}Articles - IEEE SBUI{% endblock %}

{% block extra_css %}
<style>
  @font-face {
    font-family: "Helvetica Neue";
    src: url('{% static "fonts/HelveticaNeueHeavy_0.otf" %}') format("opentype");
    font-weight: 700;
    font-style: normal;
    font-display: swap;
  }
  @font-face {
    font-family: "Helvetica Neue";
    src: url('{% static "fonts/HelveticaNeueLight_0.otf" %}') format("opentype");
    font-weight: 300;
    font-style: normal;
    font-display: swap;
  }

  /* Apply Helvetica Neue globally */
  body {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-weight: 300; /* Default to Light */
  }

  h1, h2, h3, h4, h5, h6, .custom-text-gradient {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-weight: 700; /* Heavy for headings */
  }

  /* Ensure all other elements inherit the font-family */
  * {
    font-family: inherit;
  }

  /* Dropdown styles */
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: white;
    min-width: 200px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 0.5rem;
    margin-top: 0.5rem;
  }

  .dropdown-content.show {
    display: block;
  }

  .dropdown-item {
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    color: black;
    cursor: pointer;
  }

  .dropdown-item:hover {
    background-color: #f1f1f1;
  }

  .dropdown-label {
    padding: 12px 16px;
    font-weight: bold;
    border-bottom: 1px solid #e2e8f0;
  }

  .dropdown-separator {
    height: 1px;
    background-color: #e2e8f0;
    margin: 4px 0;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
  }

  .checkbox-item input {
    margin-right: 8px;
  }

  /* Active filter badge */
  .filter-badge {
    display: inline-flex;
    align-items: center;
    background-color: #f3f4f6;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .filter-badge button {
    margin-left: 0.5rem;
    color: #6b7280;
  }

  .filter-badge button:hover {
    color: #ef4444;
  }

  /* Featured article styles */
  .featured-article {
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  /* Article card styles */
  .article-card {
    transition: transform 0.2s ease-in-out;
  }

  .article-card:hover {
    transform: translateY(-5px);
  }

  /* Pagination styles */
  .pagination-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #d1d5db;
    cursor: pointer;
  }

  .pagination-dot.active {
    background-color: #f32929;
  }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="bg-gradient-to-r from-blue-900 via-[#f32929] to-blue-900 py-32 text-center">
  <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">Articles</h1>
  <p class="text-white max-w-xl mx-auto px-4">
    Stay updated with the latest news, insights, and technological advancements
  </p>
</section>

<!-- Search and Filter Section -->
<section class="py-8 px-6 max-w-6xl mx-auto w-full">
  <div class="flex flex-col md:flex-row gap-4 items-center">
    <div class="relative flex-1 w-full">
      <form method="GET" action="{% url 'articles' %}" id="searchForm">
        <input
          type="text"
          name="search"
          placeholder="Search articles..."
          value="{{ request.GET.search|default:'' }}"
          class="w-full px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#f32929]"
        >
      </form>
    </div>
    <div class="flex gap-2">
      <!-- Filter Dropdown -->
      <div class="dropdown" id="filterDropdown">
        <button class="px-6 py-2 rounded-full border border-gray-300 hover:bg-gray-100 flex items-center" id="filterButton">
          Filter
        </button>
        <div class="dropdown-content" id="filterContent">
          <div class="dropdown-label">Sort By</div>
          <div class="dropdown-separator"></div>
          <div class="dropdown-item radio-item" data-value="recent" data-filter-type="sort">Most Recent</div>
          <div class="dropdown-item radio-item" data-value="popular" data-filter-type="sort">Most Popular</div>
          <div class="dropdown-item radio-item" data-value="oldest" data-filter-type="sort">Oldest First</div>
          <div class="dropdown-item radio-item" data-value="az" data-filter-type="sort">A-Z</div>
          <div class="dropdown-item radio-item" data-value="za" data-filter-type="sort">Z-A</div>
        </div>
      </div>

      <!-- Categories Dropdown -->
      <div class="dropdown" id="categoryDropdown">
        <button class="px-6 py-2 rounded-full border border-gray-300 hover:bg-gray-100 flex items-center" id="categoryButton">
          Categories
        </button>
        <div class="dropdown-content" id="categoryContent">
          <div class="dropdown-label">Select Category</div>
          <div class="dropdown-separator"></div>
          {% for category in categories %}
          <div class="dropdown-item checkbox-item">
            <input type="checkbox" id="category-{{ category.id }}" name="category" value="{{ category.id }}" 
              {% if category.id|stringformat:"i" in selected_categories %}checked{% endif %}>
            <label for="category-{{ category.id }}">{{ category.name }}</label>
          </div>
          {% endfor %}
          <div class="dropdown-separator"></div>
          {% comment %} TODO {% endcomment %}
          <div class="dropdown-item text-center text-sm" id="">View All Articles</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Filters Display -->
  <div class="mt-4" id="activeFilters">
    {% if request.GET.search %}
    <div class="filter-badge" data-filter-type="search" data-value="{{ request.GET.search }}">
      Search: {{ request.GET.search }}
      <button class="remove-filter">&times;</button>
    </div>
    {% endif %}
    
    {% if request.GET.sort %}
    <div class="filter-badge" data-filter-type="sort" data-value="{{ request.GET.sort }}">
      Sort: 
      {% if request.GET.sort == 'recent' %}Most Recent
      {% elif request.GET.sort == 'popular' %}Most Popular
      {% elif request.GET.sort == 'oldest' %}Oldest First
      {% elif request.GET.sort == 'az' %}A-Z
      {% elif request.GET.sort == 'za' %}Z-A
      {% endif %}
      <button class="remove-filter">&times;</button>
    </div>
    {% endif %}
    
    {% for category in selected_category_objects %}
    <div class="filter-badge" data-filter-type="category" data-value="{{ category.id }}">
      Category: {{ category.name }}
      <button class="remove-filter">&times;</button>
    </div>
    {% endfor %}
  </div>
</section>

<!-- Featured Articles -->
<section class="py-8 px-6 max-w-6xl mx-auto w-full">
  <div class="text-center mb-6">
    <h2 class="text-3xl md:text-4xl font-bold mb-2">
      <span class="text-purple-800">Featured</span> <span class="text-[#f32929]">Articles</span>
    </h2>
    <p class="text-gray-600">Highlighted articles from our contributors</p>
  </div>

  {% if featured_article %}
  <div class="featured-article p-6 mb-12">
    <div class="flex flex-col md:flex-row gap-6">
      <div class="md:w-1/4">
        <div class="relative w-full aspect-square rounded-lg overflow-hidden">
          {% if featured_article.image %}
          <img src="{{ featured_article.image.url }}" alt="{{ featured_article.title }}" class="object-cover w-full h-full">
          {% else %}
          <img src="{% static 'images/placeholder.jpg' %}" alt="Placeholder" class="object-cover w-full h-full">
          {% endif %}
        </div>
      </div>
      <div class="md:w-3/4">
        <div class="text-sm text-gray-600 mb-1">
          {{ featured_article.created_at|date:"F d, Y" }} | 
          {% for category in featured_article.categories.all %}
            {{ category.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
        <h3 class="text-2xl font-bold mb-2">{{ featured_article.title }}</h3>
        <p class="text-gray-600 mb-4">{{ featured_article.excerpt }}</p>
        <div class="flex justify-between items-center">
          <div class="text-sm">By {{ featured_article.author.get_full_name|default:featured_article.author.username }}</div>
          <a href="{% url 'article_detail' featured_article.slug %}" class="bg-[#f32929] text-white px-4 py-2 rounded-full text-sm hover:bg-red-600">
            Click For More
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</section>

<!-- Latest Articles -->
<section class="py-8 px-6 max-w-6xl mx-auto w-full">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-3xl md:text-4xl font-bold mb-2">
        <span class="text-purple-800">Latest</span> <span class="text-[#f32929]">Articles</span>
      </h2>
      <p class="text-gray-600">Stay updated with our most recent publications</p>
    </div>
    <a href="{% url 'articles' %}" class="hidden md:block border border-gray-300 px-4 py-2 rounded-full text-sm hover:bg-gray-100">
      View All Articles
    </a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="articlesContainer">
    {% for article in articles %}
    <div class="article-card border rounded-lg overflow-hidden" 
         data-categories="{% for category in article.categories.all %}{{ category.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
      <div class="relative w-full aspect-video">
        {% if article.image %}
        <img src="{{ article.image.url }}" alt="{{ article.title }}" class="object-cover w-full h-full">
        {% else %}
        <img src="{% static 'images/placeholder.jpg' %}" alt="Placeholder" class="object-cover w-full h-full">
        {% endif %}
      </div>
      <div class="p-4">
        <div class="flex justify-between items-center mb-2">
          <div class="flex items-center text-xs text-gray-600">
            <i class="far fa-calendar-alt mr-1"></i>
            {{ article.created_at|date:"F d, Y" }}
          </div>
          <span class="text-xs px-2 py-1 bg-gray-100 rounded-full">
            {% with first_category=article.categories.first %}
              {% if first_category %}
                {{ first_category.name }}
              {% else %}
                Uncategorized
              {% endif %}
            {% endwith %}
          </span>
        </div>
        <h3 class="font-bold mb-2">{{ article.title }}</h3>
        <p class="text-sm text-gray-600 mb-3">{{ article.excerpt|truncatechars:100 }}</p>
        <div class="flex justify-between items-center">
          <div class="text-xs text-gray-600">By {{ article.author.get_full_name|default:article.author.username }}</div>
          <a href="{% url 'article_detail' article.slug %}" class="text-xs text-[#f32929] hover:underline">
            Read More â†’
          </a>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-span-3 text-center py-8">
      <p class="text-gray-600">No articles found matching your criteria.</p>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
  <div class="flex justify-center items-center gap-2 mb-8">
    {% if page_obj.has_previous %}
    <a href="?{% url_replace request 'page' page_obj.previous_page_number %}" class="w-8 h-8 flex items-center justify-center rounded-full border">
      <i class="fas fa-chevron-left text-sm"></i>
    </a>
    {% endif %}
    
    {% for i in paginator.page_range %}
      {% if page_obj.number == i %}
        <span class="pagination-dot active" aria-current="page"></span>
      {% else %}
        <a href="?{% url_replace request 'page' i %}" class="pagination-dot"></a>
      {% endif %}
    {% endfor %}
    
    {% if page_obj.has_next %}
    <a href="?{% url_replace request 'page' page_obj.next_page_number %}" class="w-8 h-8 flex items-center justify-center rounded-full border">
      <i class="fas fa-chevron-right text-sm"></i>
    </a>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Dropdown functionality
    const filterButton = document.getElementById('filterButton');
    const filterContent = document.getElementById('filterContent');
    const categoryButton = document.getElementById('categoryButton');
    const categoryContent = document.getElementById('categoryContent');
    
    // Toggle filter dropdown
    filterButton.addEventListener('click', function() {
      filterContent.classList.toggle('show');
      // Close other dropdown if open
      categoryContent.classList.remove('show');
    });
    
    // Toggle category dropdown
    categoryButton.addEventListener('click', function() {
      categoryContent.classList.toggle('show');
      // Close other dropdown if open
      filterContent.classList.remove('show');
    });
    
    // Close dropdowns when clicking outside
    window.addEventListener('click', function(event) {
      if (!event.target.matches('#filterButton') && !filterContent.contains(event.target)) {
        filterContent.classList.remove('show');
      }
      if (!event.target.matches('#categoryButton') && !categoryContent.contains(event.target)) {
        categoryContent.classList.remove('show');
      }
    });
    
    // Handle sort selection
    const radioItems = document.querySelectorAll('.radio-item');
    radioItems.forEach(item => {
      item.addEventListener('click', function() {
        const value = this.getAttribute('data-value');
        const filterType = this.getAttribute('data-filter-type');
        applyFilter(filterType, value);
      });
    });
    
    // Handle category selection
    const categoryCheckboxes = document.querySelectorAll('input[name="category"]');
    categoryCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        // Get all selected categories
        const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
          .map(cb => cb.value);
        
        // Apply filter with all selected categories
        applyFilter('category', selectedCategories.join(','));
      });
    });
    
    // View all categories
    {% comment %} document.getElementById('viewAllCategories').addEventListener('click', function() {
      window.location.href = "{% url 'categories' %}";
    }); {% endcomment %}
    
    // Remove filter badges
    const removeFilterButtons = document.querySelectorAll('.remove-filter');
    removeFilterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const badge = this.parentElement;
        const filterType = badge.getAttribute('data-filter-type');
        const value = badge.getAttribute('data-value');
        
        // Remove this filter
        removeFilter(filterType, value);
      });
    });
    
    // Apply filter function
    function applyFilter(type, value) {
      // Get current URL and parameters
      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      
      // Update or add the filter parameter
      if (type === 'category') {
        // Handle multiple categories
        params.set(type, value);
      } else {
        params.set(type, value);
      }
      
      // Reset to page 1 when applying a new filter
      params.set('page', '1');
      
      // Redirect to the filtered URL
      window.location.href = `${url.pathname}?${params.toString()}`;
    }
    
    // Remove filter function
    function removeFilter(type, value) {
      // Get current URL and parameters
      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      
      if (type === 'category') {
        // Handle removing a single category from potentially multiple
        const currentCategories = params.get('category')?.split(',') || [];
        const updatedCategories = currentCategories.filter(cat => cat !== value);
        
        if (updatedCategories.length > 0) {
          params.set('category', updatedCategories.join(','));
        } else {
          params.delete('category');
        }
      } else {
        // Remove the parameter completely
        params.delete(type);
      }
      
      // Redirect to the updated URL
      window.location.href = `${url.pathname}?${params.toString()}`;
    }
    
    // Client-side filtering for immediate feedback
    function filterArticles() {
      const articles = document.querySelectorAll('.article-card');
      const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
        .map(cb => cb.value);
      
      if (selectedCategories.length === 0) {
        // Show all articles if no categories selected
        articles.forEach(article => {
          article.style.display = 'block';
        });
        return;
      }
      
      articles.forEach(article => {
        const articleCategories = article.getAttribute('data-categories').split(',');
        const hasMatchingCategory = articleCategories.some(cat => selectedCategories.includes(cat));
        
        if (hasMatchingCategory) {
          article.style.display = 'block';
        } else {
          article.style.display = 'none';
        }
      });
    }
    
    // Add event listener for search form submission
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      const searchInput = this.querySelector('input[name="search"]');
      if (searchInput.value.trim() === '') {
        e.preventDefault();
        // Remove search parameter if it exists
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        if (params.has('search')) {
          params.delete('search');
          window.location.href = `${url.pathname}?${params.toString()}`;
        }
      }
    });
  });
</script>
{% endblock %}